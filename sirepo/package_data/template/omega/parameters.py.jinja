
from pykern import pkio
from pykern.pkcollections import PKDict
import os
import sirepo.pkcli.elegant
import sirepo.pkcli.genesis
import sirepo.pkcli.opal

assert os.environ['SIREPO_SIMULATION_DB_LOGGED_IN_USER'], 'missing user id env var'


def run_sims(sim_list):
    for idx in range(len(sim_list)):
        _run(
            pkio.py_path(f'run{idx + 1}'),
            sim_list[idx].sim_type,
        )


def _run(run_dir, sim_type):
    with pkio.save_chdir(run_dir):
        if sim_type == 'opal':
            sirepo.pkcli.opal.run_opal(with_mpi=True)
        elif sim_type == 'elegant':
            sirepo.pkcli.elegant.run_elegant()
        elif sim_type == 'genesis':
            sirepo.pkcli.genesis.run_genesis(run_dir)
        else:
            raise AssertionError(f"unhandled sim_type={sim_type}")


run_sims([
{% for sim in simList %}
    PKDict(
        sim_type="{{sim.sim_type}}",
        sim_id="{{sim.sim_id}}",
    ),
{% endfor %}
])
